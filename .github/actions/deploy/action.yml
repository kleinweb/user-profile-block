# SPDX-FileCopyrightText: 2025-2026 Temple University <kleinweb@temple.edu>
#
# SPDX-License-Identifier: CC0-1.0

# yaml-language-server: $schema=https://json.schemastore.org/github-action.json
---
name: Deploy
description: Deploy with rsync to an environment

# inputs:

runs:
  using: composite
  steps:
    steps:
      # yamllint disable rule:line-length
      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p ${{ vars.TARGET_PORT }} -H ${{ vars.TARGET_HOST }} >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          eval $(ssh-agent -s)
          ssh-add ~/.ssh/id_ed25519
      # yamllint enable rule:line-length
      - name: Rsync files to host
        uses: burnett01/rsync-deployments@7.0.1
        with:
          switches: -avzr --delete â€“-exclude-from=".deployignore"
          path: /
          remote_path: ~/public
          remote_host: ${{ vars.TARGET_HOST }}
          remote_port: ${{ vars.TARGET_PORT }}
          remote_user: ${{ vars.TARGET_USER }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # yamllint disable rule:line-length
      - name: "Post-deploy: Clear Kinsta cache"
        run: |
          ssh ${{ vars.TARGET_USER }}@${{ vars.TARGET_HOST }} -p ${{ vars.TARGET_PORT }} \
          'curl https://${{ vars.TARGET_DOMAIN }}/kinsta-clear-cache-all'
      # yamllint enable rule:line-length
